<!DOCTYPE html>
<html>
<head>
    <title>è§‚ä¼—ç«¯ (Viewer)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1, h2 { color: #1a73e8; }
        video { border: 2px solid #ccc; border-radius: 8px; width: 100%; max-width: 640px; background: #000; display: block; margin-bottom: 15px;}
        #logs { white-space: pre-wrap; font-family: monospace; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; margin-top: 20px; }
        #userInfo { background-color: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .room-list { list-style: none; padding: 0; }
        .room-list li { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .room-list button { background-color: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        
        /* Consistent Button Styles */
        #in-call-view .controls button, #in-call-view > button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        #in-call-view #leaveRoomButton {
             background-color: #dc3545; /* Keep leave button red for distinction */
        }
        #in-call-view .controls input {
            border: 1px solid #ccc;
            padding: 9px;
            border-radius: 5px;
            margin-right: 5px;
        }
        #in-call-view .controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #in-call-view .controls input:disabled {
            background-color: #eee;
            cursor: not-allowed;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
</head>
<body>
    <h1>è§‚ä¼—ç«¯ (Viewer)</h1>
    <div id="userInfo"></div>

    <!-- Room Selection View -->
    <div id="room-selection-view">
        <h2>å¯ç”¨ç›´æ’­é—´</h2>
        <ul id="roomList" class="room-list"></ul>
    </div>

    <!-- In-Call View -->
    <div id="in-call-view" style="display:none;">
        <video id="remoteVideo" autoplay playsinline></video>
        <button id="leaveRoomButton">ç¦»å¼€æˆ¿é—´</button>
        <hr>
        <div class="controls">
            <input type="text" id="chatInput" placeholder="è¾“å…¥å¼¹å¹•...">
            <button id="sendChatButton">å‘é€</button>
        </div>
        <h3>äº‹ä»¶æ—¥å¿—:</h3>
        <div id="logs"></div>
    </div>

    <script>
        // --- DOM Elements ---
        const userInfoDisplay = document.getElementById('userInfo');
        const roomSelectionView = document.getElementById('room-selection-view');
        const inCallView = document.getElementById('in-call-view');
        const roomList = document.getElementById('roomList');
        const remoteVideo = document.getElementById('remoteVideo');
        const logs = document.getElementById('logs');
        const leaveRoomButton = document.getElementById('leaveRoomButton');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');

        // --- App State ---
        let peerConnection;
        let dataChannel;
        let userInfo = {};
        let broadcasterId = null;
        let currentRoomId = null;
        let isMuted = false; // New state for mute status

        // --- UI State Management ---
        function showRoomSelection() {
            inCallView.style.display = 'none';
            roomSelectionView.style.display = 'block';
            console.log('ğŸ”„ å›åˆ°æˆ¿é—´åˆ—è¡¨ã€‚');
            ws.send(JSON.stringify({ type: 'list-rooms' }));
            isMuted = false; // Reset mute status when leaving room
            updateChatControlsState();
        }
        function showInCallView() {
            roomSelectionView.style.display = 'none';
            inCallView.style.display = 'block';
        }

        function updateChatControlsState() {
            chatInput.disabled = isMuted;
            sendChatButton.disabled = isMuted;
            if (isMuted) {
                chatInput.placeholder = 'æ‚¨å·²è¢«ç¦è¨€';
            } else {
                chatInput.placeholder = 'è¾“å…¥å¼¹å¹•...';
            }
        }

        // --- Logging ---
        function log(message) {
            console.log(message);
            if(inCallView.style.display === 'block') {
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
                logs.scrollTop = logs.scrollHeight;
            }
        }

        // --- User & Room List ---
        function initializeUser() {
            const storedUserInfo = localStorage.getItem('viewerUserInfo');
            if (storedUserInfo) userInfo = JSON.parse(storedUserInfo);
            else {
                const username = prompt("è¯·è¾“å…¥æ‚¨çš„æ˜µç§°:", "è§‚ä¼—" + Math.floor(Math.random() * 1000));
                userInfo = { persistentId: uuid.v4(), username: username || "åŒ¿åè§‚ä¼—" };
                localStorage.setItem('viewerUserInfo', JSON.stringify(userInfo));
            }
            userInfoDisplay.innerHTML = `<strong>ç”¨æˆ·:</strong> ${userInfo.username} <small>(${userInfo.persistentId.substring(0, 4)})</small>`;
            updateChatControlsState(); // Set initial state
        }

        function renderRoomList(rooms) {
            roomList.innerHTML = '';
            if (rooms.length === 0) {
                roomList.innerHTML = '<li>å½“å‰æ²¡æœ‰ç›´æ’­é—´ã€‚</li>';
                return;
            }
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${room.roomName}</strong> <br><small>ä¸»æ’­: ${room.broadcasterName} | è§‚ä¼—: ${room.viewerCount}</small></div>
                              <button onclick="joinRoom('${room.roomId}')" style="background-color: #28a745;">åŠ å…¥</button>`;
                roomList.appendChild(li);
            });
        }

        // --- Signaling & Actions ---
        const ws = new WebSocket('wss://live-test-a52n.onrender.com');

        ws.onopen = () => {
            console.log('ğŸ“¡ è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨ã€‚');
            ws.send(JSON.stringify({
                type: 'register',
                payload: { persistentId: userInfo.persistentId, username: userInfo.username }
            }));
        };

        ws.onmessage = async event => {
            const message = JSON.parse(event.data);
            console.log(`ğŸ“© [server] â†’ ${message.type}`);

            switch (message.type) {
                case 'registered':
                    ws.send(JSON.stringify({ type: 'list-rooms' }));
                    break;
                case 'room-list':
                    renderRoomList(message.payload);
                    break;
                case 'joined-room':
                    currentRoomId = message.payload.roomId;
                    log(`âœ… æˆåŠŸåŠ å…¥æˆ¿é—´ ${currentRoomId.substring(0,4)}`);
                    showInCallView();
                    break;
                case 'offer':
                    handleOffer(message.payload);
                    break;
                case 'candidate':
                    handleCandidate(message.payload);
                    break;
                case 'room-closed':
                    alert(`æˆ¿é—´å·²å…³é—­ã€‚`);
                    cleanupConnection();
                    showRoomSelection();
                    break;
                case 'kicked':
                    alert(`ä½ å·²è¢«ä¸»æ’­ç§»å‡ºæˆ¿é—´ã€‚`);
                    cleanupConnection();
                    showRoomSelection();
                    break;
                case 'viewer-muted-status':
                    handleViewerMutedStatus(message.payload);
                    break;
            }
        };
        
        function joinRoom(roomId) {
            ws.send(JSON.stringify({ type: 'join-room', payload: { roomId } }));
        }

        function leaveRoom() {
            if (currentRoomId) {
                ws.send(JSON.stringify({ type: 'leave-room' }));
                cleanupConnection();
                showRoomSelection();
            }
        }
        leaveRoomButton.onclick = leaveRoom;

        function sendChatMessage() {
            if (isMuted) {
                log('ğŸš« æ‚¨å·²è¢«ç¦è¨€ï¼Œæ— æ³•å‘é€å¼¹å¹•ã€‚');
                return;
            }
            const text = chatInput.value;
            if (!text) return;
            if (dataChannel && dataChannel.readyState === 'open') {
                const message = { 
                    type: 'live.chat.message', 
                    payload: { user: userInfo.username, text: text } 
                };
                dataChannel.send(JSON.stringify(message));
                log(`ğŸ’¬ (æˆ‘) ${text}`);
                chatInput.value = '';
            } else {
                log('âš ï¸ æ— æ³•å‘é€å¼¹å¹•ï¼Œæ•°æ®é€šé“æœªè¿æ¥ã€‚');
            }
        }
        sendChatButton.onclick = sendChatMessage;


        // --- WebRTC Handlers ---
        async function handleOffer(payload) {
            if (peerConnection) return;
            broadcasterId = payload.senderId;
            log(`ğŸ¤ æ”¶åˆ°æ¥è‡ªä¸»æ’­ ${broadcasterId.substring(0,4)} çš„ Offer...`);

            peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnection.onicecandidate = e => {
                if (e.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', payload: { targetId: broadcasterId, candidate: e.candidate }}));
                }
            };
            peerConnection.ontrack = e => {
                log('â–¶ï¸ æ”¶åˆ°è¿œç¨‹åª’ä½“æµ!');
                if (remoteVideo.srcObject !== e.streams[0]) remoteVideo.srcObject = e.streams[0];
            };
            peerConnection.ondatachannel = event => {
                dataChannel = event.channel;
                dataChannel.onmessage = e => {
                    const msg = JSON.parse(e.data);
                    if(msg.type === 'live.chat.message') log(`ğŸ’¬ [${msg.payload.user}] ${msg.payload.text}`);
                    else if(msg.type === 'live.like') log(`ğŸ‘ [${msg.payload.user}] é€å‡ºç‚¹èµ`);
                    else if(msg.type === 'live.gift.send') log(`ğŸ [${msg.payload.user}] é€å‡ºç¤¼ç‰©: ${msg.payload.gift}`);
                    else if(msg.type === 'live.anchor.mute') log('ğŸ”‡ ä¸»æ’­å·²é™éŸ³');
                    else if(msg.type === 'live.anchor.unmute') log('ğŸ”Š ä¸»æ’­å·²å–æ¶ˆé™éŸ³');
                };
                dataChannel.onopen = () => log('ğŸ’¬ æ•°æ®é€šé“å·²å¼€å¯ã€‚');
                dataChannel.onclose = () => log('ğŸ’¬ æ•°æ®é€šé“å·²å…³é—­ã€‚');
            };
            peerConnection.onconnectionstatechange = () => {
                log(`ğŸ”„ è¿æ¥çŠ¶æ€: ${peerConnection.connectionState}`);
                if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
                    cleanupConnection();
                    showRoomSelection();
                }
            };
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            ws.send(JSON.stringify({ type: 'answer', payload: { targetId: broadcasterId, answer: answer }}));
        }

        async function handleCandidate(payload) {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
        }

        function handleViewerMutedStatus(payload) {
            isMuted = payload.isMuted;
            log(`${isMuted ? 'ğŸ¤« æ‚¨å·²è¢«ç¦è¨€' : 'ğŸ”Š æ‚¨å·²è¢«è§£é™¤ç¦è¨€'}`);
            updateChatControlsState();
        }

        function cleanupConnection() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }
            remoteVideo.srcObject = null;
            broadcasterId = null;
            currentRoomId = null;
            isMuted = false; // Reset mute status
            log('ğŸ§¹ æ¸…ç†è¿æ¥èµ„æºã€‚');
        }

        // --- Initial Load ---
        initializeUser();
    </script>
</body>
</html>
