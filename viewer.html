<!DOCTYPE html>
<html>
<head>
    <title>è§‚ä¼—ç«¯ (Viewer)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1, h2 { color: #1a73e8; }
        video { border: 2px solid #ccc; border-radius: 8px; width: 100%; max-width: 640px; background: #000; display: block; margin-bottom: 15px;}
        #logs { white-space: pre-wrap; font-family: monospace; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; margin-top: 20px; }
        #userInfo { background-color: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .room-list { list-style: none; padding: 0; }
        .room-list li { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .room-list button { background-color: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        #in-call-view button { background-color: #dc3545; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
</head>
<body>
    <h1>è§‚ä¼—ç«¯ (Viewer)</h1>
    <div id="userInfo"></div>

    <!-- Room Selection View -->
    <div id="room-selection-view">
        <h2>å¯ç”¨ç›´æ’­é—´</h2>
        <ul id="roomList" class="room-list"></ul>
    </div>

    <!-- In-Call View -->
    <div id="in-call-view" style="display:none;">
        <video id="remoteVideo" autoplay playsinline></video>
        <button id="leaveRoomButton">ç¦»å¼€æˆ¿é—´</button>
        <h3>äº‹ä»¶æ—¥å¿—:</h3>
        <div id="logs"></div>
    </div>

    <script>
        // --- DOM Elements ---
        const userInfoDisplay = document.getElementById('userInfo');
        const roomSelectionView = document.getElementById('room-selection-view');
        const inCallView = document.getElementById('in-call-view');
        const roomList = document.getElementById('roomList');
        const remoteVideo = document.getElementById('remoteVideo');
        const logs = document.getElementById('logs');
        const leaveRoomButton = document.getElementById('leaveRoomButton');

        // --- App State ---
        let peerConnection;
        let userInfo = {};
        let broadcasterId = null;
        let currentRoomId = null;

        // --- UI State Management ---
        function showRoomSelection() {
            inCallView.style.display = 'none';
            roomSelectionView.style.display = 'block';
            log('ğŸ”„ å›åˆ°æˆ¿é—´åˆ—è¡¨ã€‚');
            ws.send(JSON.stringify({ type: 'list-rooms' })); // Refresh room list
        }
        function showInCallView() {
            roomSelectionView.style.display = 'none';
            inCallView.style.display = 'block';
        }

        // --- Logging ---
        function log(message) {
            console.log(message);
            if(inCallView.style.display === 'block') {
                logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
                logs.scrollTop = logs.scrollHeight;
            }
        }

        // --- User & Room List ---
        function initializeUser() {
            const storedUserInfo = localStorage.getItem('viewerUserInfo');
            if (storedUserInfo) userInfo = JSON.parse(storedUserInfo);
            else {
                const username = prompt("è¯·è¾“å…¥æ‚¨çš„æ˜µç§°:", "è§‚ä¼—" + Math.floor(Math.random() * 1000));
                userInfo = { persistentId: uuid.v4(), username: username || "åŒ¿åè§‚ä¼—" };
                localStorage.setItem('viewerUserInfo', JSON.stringify(userInfo));
            }
            userInfoDisplay.innerHTML = `<strong>ç”¨æˆ·:</strong> ${userInfo.username} <small>(${userInfo.persistentId.substring(0, 4)})</small>`;
        }

        function renderRoomList(rooms) {
            roomList.innerHTML = '';
            if (rooms.length === 0) {
                roomList.innerHTML = '<li>å½“å‰æ²¡æœ‰ç›´æ’­é—´ã€‚</li>';
                return;
            }
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.innerHTML = `<div><strong>${room.roomName}</strong> <br><small>ä¸»æ’­: ${room.broadcasterName} | è§‚ä¼—: ${room.viewerCount}</small></div>
                              <button onclick="joinRoom('${room.roomId}')">åŠ å…¥</button>`;
                roomList.appendChild(li);
            });
        }

        // --- Signaling & Actions ---
        const ws = new WebSocket('wss://live-test-a52n.onrender.com');

        ws.onopen = () => {
            console.log('ğŸ“¡ è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨ã€‚');
            ws.send(JSON.stringify({
                type: 'register',
                payload: { persistentId: userInfo.persistentId, username: userInfo.username }
            }));
        };

        ws.onmessage = async event => {
            const message = JSON.parse(event.data);
            console.log(`ğŸ“© [server] â†’ ${message.type}`);

            switch (message.type) {
                case 'registered':
                    ws.send(JSON.stringify({ type: 'list-rooms' }));
                    break;
                case 'room-list':
                    renderRoomList(message.payload);
                    break;
                case 'joined-room':
                    currentRoomId = message.payload.roomId;
                    log(`âœ… æˆåŠŸåŠ å…¥æˆ¿é—´ ${currentRoomId.substring(0,4)}`);
                    showInCallView();
                    break;
                case 'offer':
                    handleOffer(message.payload);
                    break;
                case 'candidate':
                    handleCandidate(message.payload);
                    break;
                case 'room-closed':
                    alert(`æˆ¿é—´ "${message.payload.roomId.substring(0,4)}" å·²å…³é—­ã€‚`);
                    cleanupConnection();
                    showRoomSelection();
                    break;
                case 'kicked':
                    alert(`ä½ å·²è¢«ä¸»æ’­ç§»å‡ºæˆ¿é—´ã€‚`);
                    cleanupConnection();
                    showRoomSelection();
                    break;
            }
        };
        
        function joinRoom(roomId) {
            ws.send(JSON.stringify({ type: 'join-room', payload: { roomId } }));
        }

        function leaveRoom() {
            if (currentRoomId) {
                ws.send(JSON.stringify({ type: 'leave-room' }));
                cleanupConnection();
                showRoomSelection();
            }
        }
        leaveRoomButton.onclick = leaveRoom;

        // --- WebRTC Handlers ---
        async function handleOffer(payload) {
            if (peerConnection) return;
            broadcasterId = payload.senderId;
            log(`ğŸ¤ æ”¶åˆ°æ¥è‡ªä¸»æ’­ ${broadcasterId.substring(0,4)} çš„ Offer...`);

            peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            peerConnection.onicecandidate = e => {
                if (e.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', payload: { targetId: broadcasterId, candidate: e.candidate }}));
                }
            };
            peerConnection.ontrack = e => {
                log('â–¶ï¸ æ”¶åˆ°è¿œç¨‹åª’ä½“æµ!');
                if (remoteVideo.srcObject !== e.streams[0]) remoteVideo.srcObject = e.streams[0];
            };
            peerConnection.onconnectionstatechange = () => {
                log(`ğŸ”„ è¿æ¥çŠ¶æ€: ${peerConnection.connectionState}`);
                if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
                    cleanupConnection();
                    showRoomSelection();
                }
            };
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            ws.send(JSON.stringify({ type: 'answer', payload: { targetId: broadcasterId, answer: answer }}));
        }

        async function handleCandidate(payload) {
            if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
        }

        function cleanupConnection() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            remoteVideo.srcObject = null;
            broadcasterId = null;
            currentRoomId = null;
            log('ğŸ§¹ æ¸…ç†è¿æ¥èµ„æºã€‚');
        }

        // --- Initial Load ---
        initializeUser();
    </script>
</body>
</html>
