<!DOCTYPE html>
<html>
<head>
    <title>è§‚ä¼—ç«¯ (Viewer)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1 { color: #1a73e8; }
        video { border: 2px solid #ccc; border-radius: 8px; width: 520px; height: 390px; background: #000; display: block; margin-bottom: 15px;}
        #logs { white-space: pre-wrap; font-family: monospace; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>è§‚ä¼—ç«¯ (Viewer)</h1>
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="playRemoteButton" style="display:none; margin-top: 10px; padding: 10px 20px;">ç‚¹å‡»æ’­æ”¾ç›´æ’­</button>
    <h3>äº‹ä»¶æ—¥å¿—:</h3>
    <div id="logs"></div>

    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const playRemoteButton = document.getElementById('playRemoteButton');
        const logs = document.getElementById('logs');

        function log(message) {
            console.log(message);
            logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        const ws = new WebSocket('wss://live-test-a52n.onrender.com');
        let peerConnection; // ä¿å­˜ WebRTC PeerConnection å¯¹è±¡

        // --- WebSocket äº‹ä»¶å¤„ç† ---
        ws.onopen = () => {
            log('ğŸ“¡ å·²æˆåŠŸè¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨ã€‚');
        };
        ws.onerror = (error) => log(`âŒ WebSocket è¿æ¥é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}ã€‚è¯·ç¡®è®¤ä¿¡ä»¤æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨ã€‚`);
        
        ws.onmessage = async event => {
            const message = JSON.parse(event.data);
            log(`ğŸ“© æ”¶åˆ°ä¿¡ä»¤æ¶ˆæ¯: ${message.type}`);

            if (message.type === 'offer' && !peerConnection) {
                log('ğŸ¤ æ”¶åˆ°ä¸»æ’­çš„ Offerï¼Œæ­£åœ¨åˆ›å»º PeerConnection å’Œ Answer...');
                peerConnection = new RTCPeerConnection({
                    iceServers: [{urls: 'stun:stun.l.google.com:19302'}] // ä½¿ç”¨ç›¸åŒçš„ STUN æœåŠ¡å™¨
                });

                // ... (rest of peerConnection event handlers)
                // ç›‘å¬ç½‘ç»œè¿æ¥çŠ¶æ€å˜åŒ–
                peerConnection.onconnectionstatechange = () => {
                    log(`ğŸ”„ live.connection.change â†’ PeerConnection çŠ¶æ€: ${peerConnection.connectionState}`);
                    if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                        log('ğŸ›‘ live.error â†’ PeerConnection è¿æ¥æ–­å¼€æˆ–å¤±è´¥ã€‚');
                        // å¯ä»¥åœ¨è¿™é‡Œæ¸…ç†æˆ–å°è¯•é‡è¿
                    } else if (peerConnection.connectionState === 'closed') {
                         log('ğŸ‘‹ live.audience.leave â†’ ç›´æ’­è¿æ¥å·²å…³é—­ã€‚');
                         peerConnection = null; // æ¸…ç†å¯¹è±¡
                    }
                };

                // ç›‘å¬ ICE Candidate äº‹ä»¶ï¼Œå‘ç°ç½‘ç»œå€™é€‰è€…æ—¶å‘é€ç»™ä¸»æ’­
                peerConnection.onicecandidate = e => {
                    if (e.candidate) {
                        log('â¬†ï¸ å‘ç°å¹¶å‘é€ ICE Candidate åˆ°ä¿¡ä»¤æœåŠ¡å™¨...');
                        ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate }));
                    }
                };

                // ç›‘å¬ä¸»æ’­å‘æ¥çš„åª’ä½“æµ (video/audio tracks)
                peerConnection.ontrack = event => {
                    log('â–¶ï¸ live.play â†’ æ”¶åˆ°è¿œç¨‹åª’ä½“æµï¼Œå‡†å¤‡æ’­æ”¾ç›´æ’­ã€‚');
                    log(`ontrack event: ${JSON.stringify(event.streams.map(s => s.id))}, tracks: ${JSON.stringify(event.track.id)}`);
                    if (event.streams && event.streams[0]) {
                        if (remoteVideo.srcObject !== event.streams[0]) {
                            remoteVideo.srcObject = event.streams[0];
                            playRemoteButton.style.display = 'block'; // Show play button
                            log('âœ… remoteVideo.srcObject å·²è®¾ç½®ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ã€‚');
                        } else {
                            log('â„¹ï¸ remoteVideo.srcObject å·²ç»è®¾ç½®ï¼Œæ— éœ€é‡å¤ã€‚');
                        }
                    } else {
                        log('âŒ ontrack äº‹ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°åª’ä½“æµã€‚');
                    }
                };

                // ç›‘å¬æ•°æ®é€šé“ï¼ˆä¸»æ’­å¯èƒ½é€šè¿‡æ•°æ®é€šé“å‘é€èŠå¤©ã€ç‚¹èµç­‰æ¶ˆæ¯ï¼‰
                peerConnection.ondatachannel = event => {
                    const dataChannel = event.channel;
                    dataChannel.onmessage = e => {
                        const msg = JSON.parse(e.data);
                        // æ ¹æ®æ”¶åˆ°çš„æ¶ˆæ¯ç±»å‹è®°å½•æ—¥å¿—
                        if(msg.type === 'live.chat.message') log(`ğŸ’¬ live.chat.message â†’ æ”¶åˆ°æ–°å¼¹å¹•: [${msg.payload.user}] ${msg.payload.text}`);
                        else if(msg.type === 'live.like') log(`ğŸ‘ live.like â†’ æ”¶åˆ°ç‚¹èµæ¥è‡ª: ${msg.payload.user}`);
                        else if(msg.type === 'live.gift.send') log(`ğŸ live.gift.receive â†’ æ”¶åˆ°ç¤¼ç‰© [${msg.payload.gift}] æ¥è‡ª: ${msg.payload.user}`);
                        else if(msg.type === 'live.anchor.mute') log('ğŸ”‡ live.anchor.mute â†’ ä¸»æ’­å·²é™éŸ³');
                        else if(msg.type === 'live.anchor.unmute') log('ğŸ”Š live.anchor.unmute â†’ ä¸»æ’­å·²å–æ¶ˆé™éŸ³');
                    };
                    dataChannel.onopen = () => log('ğŸ’¬ æ•°æ®é€šé“å·²å¼€å¯ã€‚');
                    dataChannel.onclose = () => log('ğŸ’¬ æ•°æ®é€šé“å·²å…³é—­ã€‚');
                };
                
                // è®¾ç½®ä¸»æ’­çš„ Offer ä¸ºè¿œç«¯æè¿°
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
                
                // åˆ›å»º Answer
                log('ğŸ“„ æ­£åœ¨åˆ›å»º Answer (ä¼šè¯æè¿°)...');
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer); // è®¾ç½®ä¸ºæœ¬åœ°æè¿°
                
                // å°† Answer é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€ç»™ä¸»æ’­
                log('â¬†ï¸ å°† Answer å‘é€ç»™ä¿¡ä»¤æœåŠ¡å™¨...');
                ws.send(JSON.stringify({ type: 'answer', answer: answer }));

            } else if (message.type === 'candidate' && peerConnection) {
                // æ”¶åˆ°ä¸»æ’­çš„ ICE Candidateï¼Œæ·»åŠ åˆ° PeerConnection
                log('ğŸ“ æ”¶åˆ°ä¸»æ’­çš„ ICE Candidateï¼Œæ­£åœ¨æ·»åŠ ...');
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                } catch (e) {
                    log(`âš ï¸ æ·»åŠ  ICE Candidate å¤±è´¥: ${e.toString()}`);
                }
            } else if (message.type === 'live.audience.join') {
                // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†è§‚ä¼—åŠ å…¥çš„æ¶ˆæ¯
            }
        };

        playRemoteButton.onclick = () => {
            if (remoteVideo.srcObject) {
                remoteVideo.play().then(() => {
                    log('â–¶ï¸ ç›´æ’­å·²å¼€å§‹æ’­æ”¾ã€‚');
                    playRemoteButton.style.display = 'none'; // Hide button after playing
                }).catch(error => {
                    log(`âŒ æ’­æ”¾å¤±è´¥: ${error.message}`);
                });
            } else {
                log('â„¹ï¸ è§†é¢‘æµå°šæœªå‡†å¤‡å¥½ã€‚');
            }
        };
    </script>
</body>
</html>
