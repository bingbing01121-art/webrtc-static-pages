<!DOCTYPE html>
<html>
<head>
    <title>ä¸»æ’­ç«¯ (Broadcaster)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1 { color: #1a73e8; }
        video { border: 2px solid #ccc; border-radius: 8px; width: 520px; height: 390px; background: #000; display: block; margin-bottom: 15px;}
        .controls button, .controls input { margin: 5px; padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer; font-size: 14px; }
        .controls button { background-color: #1a73e8; color: white; }
        .controls button:hover { background-color: #155ab6; }
        .controls input { border: 1px solid #ccc; padding: 9px; }
        #logs { white-space: pre-wrap; font-family: monospace; background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ä¸»æ’­ç«¯ (Broadcaster)</h1>
    <video id="localVideo" autoplay muted playsinline></video>
    <div class="controls">
        <button id="startButton">å¼€å§‹ç›´æ’­ (live.start)</button>
        <button id="stopButton">ç»“æŸç›´æ’­ (live.stop)</button>
        <hr>
        <button id="muteButton">é™éŸ³ (live.anchor.mute)</button>
        <button id="unmuteButton">å–æ¶ˆé™éŸ³ (live.anchor.unmute)</button>
        <br>
        <button id="likeButton">ç‚¹èµ (live.like)</button>
        <button id="giftButton">é€ç¤¼ç‰© (live.gift.send)</button>
        <br>
        <input type="text" id="chatInput" placeholder="è¾“å…¥å¼¹å¹•...">
        <button id="sendChatButton">å‘é€å¼¹å¹• (live.chat.message)</button>
    </div>
    <h3>äº‹ä»¶æ—¥å¿—:</h3>
    <div id="logs"></div>

    <script>
        const localVideo = document.getElementById('localVideo');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const muteButton = document.getElementById('muteButton');
        const unmuteButton = document.getElementById('unmuteButton');
        const likeButton = document.getElementById('likeButton');
        const giftButton = document.getElementById('giftButton');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const logs = document.getElementById('logs');

        function log(message) {
            console.log(message);
            logs.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        const ws = new WebSocket('wss://live-test-a52n.onrender.com');
        let localStream;
        let peerConnection;
        let dataChannel; // æ–°å¢ï¼šç”¨äºæ•°æ®ä¼ è¾“ï¼ˆèŠå¤©ã€ç¤¼ç‰©ç­‰ï¼‰

        // --- WebSocket äº‹ä»¶å¤„ç† ---
        ws.onopen = () => log('ğŸ“¡ å·²æˆåŠŸè¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨ã€‚');
        ws.onerror = (error) => log(`âŒ WebSocket è¿æ¥é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}ã€‚è¯·ç¡®è®¤ä¿¡ä»¤æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨ã€‚`);
        ws.onmessage = async event => {
            const message = JSON.parse(event.data);
            log(`ğŸ“© æ”¶åˆ°ä¿¡ä»¤æ¶ˆæ¯: ${message.type}`);
            if (message.type === 'answer' && peerConnection) {
                log('ğŸ¤ æ”¶åˆ°è§‚ä¼—çš„ Answerï¼Œæ­£åœ¨è®¾ç½®è¿œç«¯æè¿°...');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
            } else if (message.type === 'candidate' && peerConnection) {
                 log('ğŸ“ æ”¶åˆ°è§‚ä¼—çš„ ICE Candidateï¼Œæ­£åœ¨æ·»åŠ ...');
                 try {
                     await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                 } catch (e) {
                     log(`âš ï¸ æ·»åŠ  ICE Candidate å¤±è´¥: ${e.toString()}`);
                 }
            }
        };

        // --- åª’ä½“è®¾å¤‡åˆå§‹åŒ– ---
        async function initMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                log('âœ… live.ready â†’ ç›´æ’­åˆå§‹åŒ–å®Œæˆï¼Œæ‘„åƒå¤´å’Œéº¦å…‹é£å·²å°±ç»ªã€‚');
            } catch (e) {
                log(`âŒ è·å–åª’ä½“è®¾å¤‡å¤±è´¥: ${e.toString()}ã€‚è¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚`);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´æˆ–éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®ã€‚');
            }
        }

        // --- æ•°æ®é€šé“æ¶ˆæ¯å‘é€è¾…åŠ©å‡½æ•° ---
        function sendDataChannelMessage(type, payload) {
            if (dataChannel && dataChannel.readyState === 'open') {
                const message = JSON.stringify({ type, payload });
                dataChannel.send(message);
                log(`ğŸ“¤ (é€šè¿‡æ•°æ®é€šé“å‘é€) ${type}: ${JSON.stringify(payload) || 'æ— å†…å®¹'}`);
            } else {
                log('âŒ æ•°æ®é€šé“æœªå¼€å¯æˆ–æœªåˆ›å»ºï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼');
            }
        }

        // --- æŒ‰é’®äº‹ä»¶å¤„ç† ---
        startButton.onclick = async () => {
            if (!localStream) {
                alert('åª’ä½“è®¾å¤‡æœªå°±ç»ªï¼Œè¯·ç¨å€™æˆ–æ£€æŸ¥æƒé™ï¼');
                return;
            }
            log('â–¶ï¸ live.start â†’ ç”¨æˆ·ç‚¹å‡»å¼€å§‹ç›´æ’­ï¼Œåˆ›å»º PeerConnection...');
            
                                                peerConnection = new RTCPeerConnection({
            
                                                    iceServers: [
            
                                                        { urls: 'stun:stun.l.google.com:19302' },
            
                                                        { urls: 'stun:stun1.l.google.com:19302' },
            
                                                        { urls: 'stun:stun2.l.google.com:19302' },
            
                                                        { urls: 'stun:stun3.l.google.com:19302' },
            
                                                        { urls: 'stun:stun4.l.google.com:19302' },
            
                                                        { 
            
                                                          urls: "turn:openrelay.metered.ca:80",
            
                                                          username: "openrelayproject",
            
                                                          credential: "openrelayproject",
            
                                                        }
            
                                                    ] 
            
                                                });

            // **æ–°å¢ï¼šåˆ›å»ºæ•°æ®é€šé“**
            dataChannel = peerConnection.createDataChannel("chat");
            dataChannel.onopen = () => log('ğŸ’¬ æ•°æ®é€šé“å·²å¼€å¯ã€‚');
            dataChannel.onclose = () => log('ğŸ’¬ æ•°æ®é€šé“å·²å…³é—­ã€‚');
            dataChannel.onerror = (error) => log(`âŒ æ•°æ®é€šé“é”™è¯¯: ${error}`);
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                }
            };

            peerConnection.onconnectionstatechange = () => {
                log(`ğŸ”„ live.connection.change â†’ PeerConnection çŠ¶æ€: ${peerConnection.connectionState}`);
            };
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            log('â¬†ï¸ å°† Offer å‘é€ç»™ä¿¡ä»¤æœåŠ¡å™¨...');
            ws.send(JSON.stringify({ type: 'offer', offer: offer }));
        };

        stopButton.onclick = () => {
            log('â¹ï¸ live.stop â†’ ç›´æ’­æ¨æµç»“æŸ');
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
        };

        muteButton.onclick = () => {
            if(localStream) localStream.getAudioTracks()[0].enabled = false;
            sendDataChannelMessage('live.anchor.mute');
        };
        
        unmuteButton.onclick = () => {
            if(localStream) localStream.getAudioTracks()[0].enabled = true;
            sendDataChannelMessage('live.anchor.unmute');
        };

        likeButton.onclick = () => sendDataChannelMessage('live.like', { user: 'ä¸»æ’­' });
        
        giftButton.onclick = () => sendDataChannelMessage('live.gift.send', { user: 'ä¸»æ’­', gift: 'ç«ç®­', count: 1 });
        
        sendChatButton.onclick = () => {
            if (chatInput.value) {
                sendDataChannelMessage('live.chat.message', { user: 'ä¸»æ’­', text: chatInput.value });
                chatInput.value = '';
            }
        };
        
        initMedia();
    </script>
</body>
</html>